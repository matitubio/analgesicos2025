<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factura - Analg√©sicos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:16px; background:#f4f4f4; }
    .container { max-width:640px; margin:0 auto; background:#fff; padding:14px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h1 { text-align:center; font-size:20px; margin:6px 0 12px; color:#333;}
    .cliente { text-align:center; color:#555; margin-bottom:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px 6px; border-bottom:1px solid #e9e9e9; text-align:left; }
    th { background:#fafafa; font-weight:600; }
    .total { text-align:right; font-weight:700; color:#28a745; margin-top:10px; font-size:16px; }
    .actions { display:flex; gap:10px; margin-top:14px; }
    button { flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer; font-size:14px; }
    .btn-pdf { background:#ff9800; color:#fff; }
    .btn-wa { background:#25D366; color:#fff; }
    .btn-volver { background:#007bff; color:#fff; }
    @media (print) { .actions{ display:none } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Factura</h1>
    <div id="cliente" class="cliente"></div>

    <table aria-label="Detalle de compra">
      <thead>
        <tr><th>Producto</th><th>Cant.</th><th>Unit.</th><th>Subtotal</th></tr>
      </thead>
      <tbody id="items"></tbody>
    </table>

    <div id="total" class="total">Total: $0</div>

    <div class="actions">
      <button class="btn-pdf" id="btnPDF">üìÑ Descargar PDF</button>
      <button class="btn-wa" id="btnWhatsApp">üí¨ Enviar por WhatsApp</button>
      <button class="btn-volver" id="btnVolver">‚Ü©Ô∏è Volver</button>
    </div>
  </div>

  <script>
    // ---- Leer datos guardados por index.html (key: 'compra') ----
    const datosCompra = JSON.parse(localStorage.getItem('compra'));
    if (!datosCompra || !datosCompra.items || datosCompra.items.length === 0) {
      alert('No hay datos de compra. Se te redirigir√° a la tienda.');
      window.location.href = 'index.html';
    } else {
      // Mostrar cliente
      const clienteElem = document.getElementById('cliente');
      clienteElem.innerHTML = `<strong>Cliente:</strong> ${datosCompra.cliente || '-'}`;

      // Rellenar tabla
      const tbody = document.getElementById('items');
      let total = 0;
      let rowsHtml = '';
      datosCompra.items.forEach(it => {
        const subtotal = Number(it.precio) * Number(it.cantidad);
        total += subtotal;
        rowsHtml += `<tr>
          <td>${it.nombre}</td>
          <td>${it.cantidad}</td>
          <td>$${Number(it.precio).toLocaleString()}</td>
          <td>$${subtotal.toLocaleString()}</td>
        </tr>`;
      });
      tbody.innerHTML = rowsHtml;
      document.getElementById('total').textContent = `Total: $${total.toLocaleString()}`;

      // No eliminar la key aqu√≠ para que el usuario pueda descargar/enviar varias veces.
    }

    // ---- Descargar PDF con jsPDF ----
    document.getElementById('btnPDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      let y = 40;
      doc.setFontSize(16);
      doc.text('Factura de compra', 40, y);
      y += 20;

      doc.setFontSize(11);
      const clienteTxt = `Cliente: ${datosCompra.cliente || '-'}`;
      doc.text(clienteTxt, 40, y);
      y += 18;

      // Headers
      doc.setFontSize(11);
      doc.text('Producto', 40, y);
      doc.text('Cant.', 300, y);
      doc.text('Unit.', 360, y);
      doc.text('Subtotal', 440, y);
      y += 8;
      doc.setLineWidth(0.5);
      doc.line(40, y, 552, y);
      y += 14;

      // Items
      datosCompra.items.forEach(it => {
        const nombre = it.nombre;
        const cantidad = String(it.cantidad);
        const unit = `$${Number(it.precio).toLocaleString()}`;
        const subtotal = `$${(Number(it.precio) * Number(it.cantidad)).toLocaleString()}`;

        // Handle long product names by splitting
        const maxWidth = 240; // puntos
        const lines = doc.splitTextToSize(nombre, maxWidth);
        doc.text(lines, 40, y);
        // write the other columns on the first line of name
        doc.text(cantidad, 300, y);
        doc.text(unit, 360, y);
        doc.text(subtotal, 440, y);
        y += (lines.length * 14) + 6;

        if (y > 740) { // nueva p√°gina
          doc.addPage();
          y = 40;
        }
      });

      // Total al final
      const total = datosCompra.items.reduce((s, it) => s + (Number(it.precio) * Number(it.cantidad)), 0);
      doc.setTextColor(40, 167, 69);
      doc.setFontSize(13);
      doc.text(`Total: $${total.toLocaleString()}`, 440, y + 10, { align: 'right' });

      // Nombre de archivo con fecha
      const fecha = new Date().toISOString().slice(0,10);
      const nombreArchivo = `Factura_${(datosCompra.cliente||'cliente').replace(/\s+/g,'_')}_${fecha}.pdf`;

      doc.save(nombreArchivo);
      // opcional: localStorage.removeItem('compra'); // si quer√©s limpiar despu√©s de descargar
    });

    // ---- Enviar mensaje por WhatsApp (abre app en m√≥vil) ----
    document.getElementById('btnWhatsApp').addEventListener('click', () => {
      let mensaje = "üßæ Factura de compra:\n\n";
      datosCompra.items.forEach(it => {
        mensaje += `- ${it.nombre} x${it.cantidad} = $${(Number(it.precio) * Number(it.cantidad)).toLocaleString()}\n`;
      });
      const total = datosCompra.items.reduce((s, it) => s + (Number(it.precio) * Number(it.cantidad)), 0);
      mensaje += `\nTotal: $${total.toLocaleString()}\n\nGracias por su compra.`;

      // wa.me abrir√° la app en m√≥vil si est√° instalada
      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
      // opcional: localStorage.removeItem('compra'); // si quer√©s limpiar despu√©s de enviar
    });

    // ---- Volver a tienda ----
    document.getElementById('btnVolver').addEventListener('click', () => {
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
